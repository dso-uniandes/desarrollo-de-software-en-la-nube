# üèÄ ANB - Cloud Project

Este proyecto implementa una API REST con **FastAPI** que permite subir archivos a **AWS S3 Bucket**, autenticarse mediante JWT y manejar una base de datos PostgreSQL

---

## üìò Documentaci√≥n del Proyecto

Dentro del repositorio existe una carpeta `/docs/Entrega_1` que contiene toda la documentaci√≥n t√©cnica de la primera entrega, incluyendo:

- **Modelo de datos (ERD):** `data_model.md`
- **Diagrama de componentes de la arquitectura:** `component_diagram.md`
- **Flujo de procesamiento de videos:** `process_flow.md`
- **Gu√≠a de despliegue e infraestructura:** `deployment.md`
- **Colecciones de Postman:** `/collections/`

```
üìÇ root-folder/
‚îî‚îÄ‚îÄ üìÇ docs/
    ‚îî‚îÄ‚îÄ üìÇ Entrega_1/
        ‚îú‚îÄ‚îÄ data_model.md
        ‚îú‚îÄ‚îÄ component_diagram.md
        ‚îú‚îÄ‚îÄ process_flow.md
        ‚îú‚îÄ‚îÄ deployment.md
        ‚îî‚îÄ‚îÄ sonar_reporte.pdf
```

---

## üöÄ Caracter√≠sticas principales

* Upload de archivos directamente a **AWS Cloud Storage**
* Soporte para entornos **test**, **dev** y **prod**
* Configuraci√≥n basada en **Pydantic Settings** y **dotenv (.env)**
* Conexi√≥n a base de datos **PostgreSQL** v√≠a **SQLAlchemy ORM**
* Tests autom√°ticos con `pytest` y `pytest-asyncio`

---

## ‚öôÔ∏è Requisitos previos

* **Python 3.13**
* **PostgreSQL** (para entorno de desarrollo)
* **Docker Desktop**
* **Cuenta en AWS** con credenciales v√°lidas
* **Acceso al bucket creado en AWS S3**

---

## üê≥ Configuraci√≥n de PostgreSQL con Docker

### Levantar PostgreSQL con Docker
Ejecuta el siguiente comando para levantar PostgreSQL:

```bash
docker run --name postgres-anb -e POSTGRES_PASSWORD=password -e POSTGRES_DB=dev_db -p 5432:5432 -d postgres:15
```

### Verificar que PostgreSQL est√© corriendo
```bash
docker ps
```

Deber√≠as ver el contenedor `postgres-anb` corriendo en el puerto 5432.

---

## üß© Configuraci√≥n del entorno

Crea un archivo llamado `.env` en la ra√≠z del proyecto con el siguiente contenido:

```dotenv
# Estado del entorno (dev, test, prod)
ENV_STATE=dev

# Base de datos PostgreSQL local (Docker)
DEV_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/dev_db

# Base de datos de test
TEST_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/test_db

# Base de datos de prod 
PROD_DATABASE_URL=anb-database.csxqmc4ywsa4.us-east-1.rds.amazonaws.com

# Credenciales de AWS S3
DEV_AWS_BUCKET_NAME=anb-s3-bucket
DEV_AWS_REGION=us-east-1
DEV_AWS_ACCESS_KEY_ID=tu_access_key
DEV_AWS_SECRET_ACCESS_KEY=tu_secret_key
```

---

## ‚ñ∂Ô∏è Ejecuci√≥n local

### 1. Instalar dependencias
```bash
pip install -r requirements.txt
```

### 2. Configurar variables de entorno
Aseg√∫rate de que tu archivo `.env` est√© configurado correctamente (ver secci√≥n anterior).

### 3. Ejecutar el servidor FastAPI
```bash
# Con variables de entorno (PowerShell)
$env:ENV_STATE="dev"; $env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"; python -m uvicorn storeapi.main:app --reload --host 0.0.0.0 --port 8000

# Con archivo .env configurado
python -m uvicorn storeapi.main:app --reload --host 0.0.0.0 --port 8000
```

### 4. Acceder a la documentaci√≥n
üåê  [http://localhost:8000/docs](http://localhost:8000/docs)

**Nota**: El servidor crear√° autom√°ticamente las tablas en PostgreSQL al iniciar.

---

## üß™ Ejecutar Tests As√≠ncronos

### Requisitos para los tests
Los tests requieren que PostgreSQL est√© corriendo (usando Docker) y que las variables de entorno est√©n configuradas.

### Comandos para ejecutar tests

#### 1. Tests b√°sicos (PowerShell)
```bash
# Configurar entorno de test y ejecutar
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/ -v
```

#### 2. Tests con salida detallada
```bash
# Con informaci√≥n detallada de cada test
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/ -v --tb=short
```

#### 3. Tests espec√≠ficos
```bash
# Ejecutar solo tests de un m√≥dulo espec√≠fico
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/routers/test_user.py -v

# Ejecutar un test espec√≠fico
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/routers/test_user.py::test_create_user -v
```

### ‚ö†Ô∏è Notas importantes sobre los tests

1. **Base de datos de test**: Los tests usan una base de datos separada (`test_db`) que se crea autom√°ticamente
2. **Rollback autom√°tico**: Los tests est√°n configurados para hacer rollback autom√°tico de los datos
3. **Tests as√≠ncronos**: Todos los tests son as√≠ncronos y usan `pytest-asyncio`
4. **Docker requerido**: PostgreSQL debe estar corriendo en Docker para que los tests funcionen

---

## üöÄ Ejecutar Tests con Newman (Postman CLI)

### Requisitos para Newman
- **Newman instalado**: `npm install -g newman`
- **Servidor corriendo**: FastAPI debe estar ejecut√°ndose en `http://localhost:8000`
- **PostgreSQL corriendo**: Docker container `postgres-anb` debe estar activo
- **Kafka corriendo**: Para el procesamiento as√≠ncrono de videos
- **Worker corriendo**: Para procesar los videos subidos

### Procedimiento Completo para Ejecutar Tests

#### 1. Configuraci√≥n Inicial
Aseg√∫rate de que todos los servicios est√©n corriendo:

```bash
# 1. Verificar que PostgreSQL est√© corriendo
docker ps

# 2. Verificar que el contenedor postgres-anb est√© activo
docker logs postgres-anb
```

#### 2. Configuraci√≥n de Variables de Entorno
Configura las variables de entorno necesarias para el desarrollo:

```bash
# Variables de entorno para desarrollo (PowerShell)
$env:ENV_STATE="dev"
$env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"
$env:DEV_AWS_ACCESS_KEY_ID="test_key"
$env:DEV_AWS_SECRET_ACCESS_KEY="test_secret"
$env:DEV_AWS_BUCKET_NAME="test_bucket"
$env:DEV_AWS_REGION="us-east-1"
$env:KAFKA_BOOTSTRAP_SERVERS="localhost:9092"
```

#### 3. Levantar el Servidor FastAPI
```bash
# Iniciar el servidor FastAPI con todas las variables de entorno
$env:ENV_STATE="dev"; $env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"; $env:DEV_AWS_ACCESS_KEY_ID="test_key"; $env:DEV_AWS_SECRET_ACCESS_KEY="test_secret"; $env:DEV_AWS_BUCKET_NAME="test_bucket"; $env:DEV_AWS_REGION="us-east-1"; $env:KAFKA_BOOTSTRAP_SERVERS="localhost:9092"; python -m uvicorn storeapi.main:app --reload --host 0.0.0.0 --port 8000
```

#### 4. Levantar el Worker de Procesamiento
En una terminal separada, inicia el worker que procesa los videos:

```bash
# Iniciar el worker de Kafka para procesamiento de videos
$env:ENV_STATE="dev"; $env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"; $env:DEV_AWS_ACCESS_KEY_ID="test_key"; $env:DEV_AWS_SECRET_ACCESS_KEY="test_secret"; $env:DEV_AWS_BUCKET_NAME="test_bucket"; $env:DEV_AWS_REGION="us-east-1"; $env:KAFKA_BOOTSTRAP_SERVERS="localhost:9092"; python -m message_broker.worker
```

#### 5. Verificar que los Servicios Est√©n Funcionando
- **FastAPI**: Debe estar disponible en `http://localhost:8000`
- **Worker**: Debe mostrar logs de conexi√≥n a la base de datos y Kafka
- **PostgreSQL**: Debe estar corriendo en el puerto 5432

#### 6. Ejecutar Tests con Newman
```bash
# Ejecutar toda la colecci√≥n de tests
newman run collections/Cloud-ANB.postman_collection.json --environment collections/postman_environment.json
```

### ‚ö†Ô∏è Notas Importantes sobre los Tests

1. **Procesamiento As√≠ncrono**: Los tests incluyen un delay de 10 segundos para esperar que los videos se procesen
2. **Worker Requerido**: El worker de Kafka debe estar corriendo para que los videos se procesen correctamente
3. **Base de Datos**: Los tests crean usuarios y videos de prueba que se almacenan en la base de datos
4. **Votaci√≥n**: Los tests de votaci√≥n requieren que los videos est√©n en estado "processed"
5. **Autenticaci√≥n**: Los tests manejan autom√°ticamente la autenticaci√≥n JWT

### üîß Soluci√≥n de Problemas

#### Si los tests fallan:
1. **Verificar que el worker est√© corriendo**: Debe mostrar logs de procesamiento de videos
2. **Verificar la base de datos**: Los videos deben cambiar de estado "uploaded" a "processed"
3. **Verificar Kafka**: El worker debe conectarse correctamente a Kafka
4. **Verificar el logo**: El archivo `img/logo_nba.png` debe existir para el procesamiento

#### Logs esperados del Worker:
```
2025-10-18 22:21:09 - INFO - databases - Connected to database postgresql+asyncpg://postgres:********@localhost:5432/dev_db
2025-10-18 22:21:09 - INFO - worker - Database connection established.
2025-10-18 22:21:13 - INFO - worker - Received message: {"video_id": 54, "user_id": 49, "task_id": "..."}
2025-10-18 22:21:13 - INFO - worker - Processing video: {...}
```

### üìä Resultados Esperados
Al ejecutar los tests exitosamente, deber√≠as ver:
- **25 requests ejecutados** ‚úÖ
- **22 test scripts ejecutados** ‚úÖ  
- **26 pre-request scripts ejecutados** ‚úÖ
- **61 de 61 assertions pasaron** ‚úÖ (100% de √©xito)

---

## ‚öôÔ∏è Comandos √∫tiles

### Docker
```bash
# Ver contenedores corriendo
docker ps

# Ver logs del contenedor PostgreSQL
docker logs postgres-anb

# Conectar a PostgreSQL desde terminal
docker exec -it postgres-anb psql -U postgres

# Detener el contenedor
docker stop postgres-anb

# Iniciar el contenedor
docker start postgres-anb

# Eliminar el contenedor
docker rm postgres-anb
```

---

## üìÅ Estructura del proyecto

```
fastApi/
‚îú‚îÄ‚îÄ storeapi/                    # Aplicaci√≥n principal
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                  # Punto de entrada FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ config.py                # Configuraci√≥n con Pydantic
‚îÇ   ‚îú‚îÄ‚îÄ database.py              # Configuraci√≥n de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ security.py              # Autenticaci√≥n JWT
‚îÇ   ‚îú‚îÄ‚îÄ routers/                 # Endpoints de la API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py             # Gesti√≥n de usuarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post.py             # Posts y comentarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video.py            # Upload y procesamiento de videos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vote.py             # Sistema de votos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ranking.py          # Rankings y estad√≠sticas
‚îÇ   ‚îú‚îÄ‚îÄ models/                  # Modelos de datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vote.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ranking.py
‚îÇ   ‚îú‚îÄ‚îÄ tests/                   # Tests unitarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conftest.py         # Configuraci√≥n de pytest
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_security.py    # Tests de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routers/            # Tests de endpoints
‚îÇ   ‚îî‚îÄ‚îÄ libs/                    # Utilidades
‚îÇ       ‚îú‚îÄ‚îÄ cache.py
‚îÇ       ‚îî‚îÄ‚îÄ s3/                  # Integraci√≥n con AWS S3
‚îú‚îÄ‚îÄ requirements.txt             # Dependencias Python
‚îú‚îÄ‚îÄ .env                        # Variables de entorno (crear)
‚îî‚îÄ‚îÄ README.md                   # Este archivo
```

---
