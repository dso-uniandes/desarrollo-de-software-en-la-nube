# üèÄ ANB - Cloud Project

Este proyecto implementa una API REST con **FastAPI** que permite subir archivos a **AWS S3 Bucket**, autenticarse mediante JWT y manejar una base de datos PostgreSQL

---

## üö¶ Inicio R√°pido

### Para ejecutar la aplicaci√≥n:
```bash
# Opci√≥n 1: Docker Compose (Recomendado)
docker compose up -d
# Acceder: http://localhost/docs

# Opci√≥n 2: Desarrollo Local
# Ver secci√≥n "Ejecuci√≥n en Desarrollo Local"
```

### Para ejecutar tests:
```bash
# Tests unitarios (pytest)
ENV_STATE=test TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db" python -m pytest storeapi/tests/ -v

# Tests de integraci√≥n (Newman)
make newman
```

### Para monitorear recursos:
```bash
./monitor.sh
```

---

## üìò Documentaci√≥n del Proyecto

Dentro del repositorio existe una carpeta `/docs/Entrega_1` que contiene toda la documentaci√≥n t√©cnica de la primera entrega, incluyendo:

- **Modelo de datos (ERD):** `data_model.md`
- **Diagrama de componentes de la arquitectura:** `component_diagram.md`
- **Flujo de procesamiento de videos:** `process_flow.md`
- **Gu√≠a de despliegue e infraestructura:** `deployment.md`
- **Colecciones de Postman:** `/collections/`

```
üìÇ root-folder/
‚îî‚îÄ‚îÄ üìÇ docs/
    ‚îî‚îÄ‚îÄ üìÇ Entrega_1/
        ‚îú‚îÄ‚îÄ data_model.md
        ‚îú‚îÄ‚îÄ component_diagram.md
        ‚îú‚îÄ‚îÄ process_flow.md
        ‚îú‚îÄ‚îÄ deployment.md
        ‚îî‚îÄ‚îÄ sonar_reporte.pdf
```

---

## üöÄ Caracter√≠sticas principales

* Upload de archivos directamente a **AWS Cloud Storage**
* Soporte para entornos **test**, **dev** y **prod**
* Configuraci√≥n basada en **Pydantic Settings** y **dotenv (.env)**
* Conexi√≥n a base de datos **PostgreSQL** v√≠a **SQLAlchemy ORM**
* Tests autom√°ticos con `pytest` y `pytest-asyncio`

---

## ‚öôÔ∏è Requisitos previos

* **Python 3.13**
* **PostgreSQL** (para entorno de desarrollo)
* **Docker Desktop**
* **Cuenta en AWS** con credenciales v√°lidas
* **Acceso al bucket creado en AWS S3**

---

## üê≥ Configuraci√≥n de PostgreSQL con Docker

### Levantar PostgreSQL con Docker
Ejecuta el siguiente comando para levantar PostgreSQL:

```bash
docker run --name postgres-anb -e POSTGRES_PASSWORD=password -e POSTGRES_DB=dev_db -p 5432:5432 -d postgres:15
```

### Verificar que PostgreSQL est√© corriendo
```bash
docker ps
```

Deber√≠as ver el contenedor `postgres-anb` corriendo en el puerto 5432.

---

## üß© Configuraci√≥n del entorno

Crea un archivo llamado `.env` en la ra√≠z del proyecto con el siguiente contenido:

```dotenv
# Estado del entorno (dev, test, prod)
ENV_STATE=dev

# Base de datos PostgreSQL local (Docker)
DEV_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/dev_db

# Base de datos de test
TEST_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/test_db

# Base de datos de prod 
PROD_DATABASE_URL=anb-database.csxqmc4ywsa4.us-east-1.rds.amazonaws.com

# Credenciales de AWS S3
DEV_AWS_BUCKET_NAME=anb-s3-bucket
DEV_AWS_REGION=us-east-1
DEV_AWS_ACCESS_KEY_ID=tu_access_key
DEV_AWS_SECRET_ACCESS_KEY=tu_secret_key

# Kafka (Message Broker)
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
KAFKA_GROUP_ID=video_tasks_group

# Redis (Cach√© - opcional)
REDIS_URL=redis://localhost:6379
RANKING_CACHE_TTL=300

# Almacenamiento local de videos
UPLOADED_FOLDER=videos/uploaded
PROCESSED_FOLDER=videos/processed

# Configuraci√≥n del servidor
APP_HOST=0.0.0.0
APP_PORT=8000
```

---

## üß™ Tests Automatizados (pytest)

### Requisitos
- PostgreSQL corriendo (contenedor Docker standalone)
- Python 3.13 con dependencias instaladas

### 1. Levantar PostgreSQL para Tests
```bash
# Levantar PostgreSQL standalone (si no est√° corriendo)
docker run --name postgres-anb -e POSTGRES_PASSWORD=password -e POSTGRES_DB=dev_db -p 5432:5432 -d postgres:15

# Verificar que est√© corriendo
docker ps
```

### 2. Ejecutar Tests con pytest

#### Tests b√°sicos
```bash
# Todos los tests (PowerShell)
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/ -v

# Tests b√°sicos (Bash/zsh)
ENV_STATE=test TEST_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/test_db python -m pytest storeapi/tests/ -v
```

#### Tests con salida detallada
```bash
# PowerShell
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/ -v --tb=short

# Bash/zsh
ENV_STATE=test TEST_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/test_db python -m pytest storeapi/tests/ -v --tb=short
```

#### Tests espec√≠ficos
```bash
# Test de un m√≥dulo espec√≠fico (PowerShell)
$env:ENV_STATE="test"; $env:TEST_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/test_db"; python -m pytest storeapi/tests/routers/test_user.py -v

# Test de un m√≥dulo espec√≠fico (Bash/zsh)
ENV_STATE=test TEST_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/test_db python -m pytest storeapi/tests/routers/test_user.py -v

# Test espec√≠fico por nombre
ENV_STATE=test TEST_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/test_db python -m pytest storeapi/tests/routers/test_user.py::test_create_user -v
```

### ‚ÑπÔ∏è Caracter√≠sticas de los Tests
- ‚úÖ **Base de datos separada**: Usa `test_db` (aislada de desarrollo)
- ‚úÖ **Rollback autom√°tico**: Los datos se limpian despu√©s de cada test
- ‚úÖ **Tests as√≠ncronos**: Utilizan `pytest-asyncio`
- ‚úÖ **Cobertura completa**: Autenticaci√≥n, usuarios, videos, votos, ranking

---

## üê≥ Ejecuci√≥n con Docker Compose (Recomendado)

### 1. Configurar archivo .env
Aseg√∫rate de tener un archivo `.env` en la ra√≠z con la siguiente configuraci√≥n m√≠nima:

```dotenv
# Estado del entorno
ENV_STATE=dev

# AWS S3 (usar credenciales locales para desarrollo)
DEV_AWS_BUCKET_NAME=anb-local-bucket
DEV_AWS_REGION=us-east-1
DEV_AWS_ACCESS_KEY_ID=test_key
DEV_AWS_SECRET_ACCESS_KEY=test_secret

# Kafka (no es necesario configurar, Docker Compose lo maneja)
# DEV_DATABASE_URL se configura autom√°ticamente en docker-compose.yml
```

### 2. Levantar todos los servicios

```bash
# Levantar toda la infraestructura
docker compose up -d

# Ver logs en tiempo real (opcional)
docker compose logs -f

# Verificar estado de servicios
docker compose ps
```

**Servicios levantados:**
- üóÑÔ∏è **PostgreSQL** (puerto 5432)
- üåê **StoreAPI** (expuesto internamente en puerto 8000)
- üîÑ **Nginx** (puerto 80) - Proxy reverso
- üì® **Kafka** (puerto 9092) - Message broker
- ‚öôÔ∏è **Worker** - Procesamiento de videos con FFmpeg
- üíæ **Redis** (puerto 6379) - Cach√©

### 3. Verificar que los servicios est√©n listos

```bash
# Verificar todos los contenedores
docker compose ps

# Salida esperada:
# NAME          STATUS          PORTS
# database      Up (healthy)    0.0.0.0:5432->5432/tcp
# storeapi      Up              8000/tcp
# proxy         Up              0.0.0.0:80->80/tcp
# kafka         Up (healthy)    0.0.0.0:9092->9092/tcp
# worker        Up              
# redis         Up              0.0.0.0:6379->6379/tcp

# Ver logs de un servicio espec√≠fico
docker compose logs storeapi --tail 50
docker compose logs worker --tail 50
```

### 4. Acceder a la API

üåê **API**: [http://localhost/docs](http://localhost/docs)  
üîó **Endpoints**:
- `http://localhost/api/auth/login`
- `http://localhost/api/videos/upload`
- `http://localhost/api/ranking`

### 5. Ejecutar Tests con Newman (Docker Compose)

**Prerequisitos:**
```bash
# Instalar Newman si no lo tienes
npm install -g newman

# Verificar instalaci√≥n
newman --version
```

**Ejecutar tests:**
```bash
# Ejecutar toda la colecci√≥n de tests
newman run collections/Cloud-ANB.postman_collection.json --environment collections/postman_environment.json
```

**Resultados esperados:**
Al ejecutar los tests exitosamente, deber√≠as ver:
- **25 requests ejecutados** ‚úÖ
- **22 test scripts ejecutados** ‚úÖ  
- **26 pre-request scripts ejecutados** ‚úÖ
- **61 de 61 assertions pasaron** ‚úÖ (100% de √©xito)

**Nota importante:**
- Los tests incluyen un delay de 10 segundos para esperar que los videos se procesen
- El worker de Kafka debe estar corriendo para que los videos se procesen correctamente
- Los tests de votaci√≥n requieren que los videos est√©n en estado "processed"

---

## ‚ñ∂Ô∏è Ejecuci√≥n en Desarrollo Local (Sin Docker Compose)

Para desarrollo local con m√°s control y debugging.

### 1. Instalar dependencias
```bash
pip install -r requirements.txt
```

### 2. Levantar servicios individuales

#### PostgreSQL
```bash
docker run --name postgres-anb -e POSTGRES_PASSWORD=password -e POSTGRES_DB=dev_db -p 5432:5432 -d postgres:15
```

#### Kafka (opcional, si necesitas procesamiento de videos)
```bash
docker run --name kafka-dev -p 9092:9092 -e KAFKA_ENABLE_KRAFT=yes -e KAFKA_CFG_NODE_ID=1 -e KAFKA_CFG_PROCESS_ROLES=broker,controller -e KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@localhost:9093 -e KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093 -e KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 -e KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER bitnamilegacy/kafka:4.0.0-debian-12-r10
```

### 3. Configurar variables de entorno

**PowerShell:**
```powershell
$env:ENV_STATE="dev"
$env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"
$env:DEV_AWS_ACCESS_KEY_ID="test_key"
$env:DEV_AWS_SECRET_ACCESS_KEY="test_secret"
$env:DEV_AWS_BUCKET_NAME="test_bucket"
$env:DEV_AWS_REGION="us-east-1"
$env:KAFKA_BOOTSTRAP_SERVERS="localhost:9092"
```

**Bash/zsh:**
```bash
export ENV_STATE=dev
export DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"
export DEV_AWS_ACCESS_KEY_ID="test_key"
export DEV_AWS_SECRET_ACCESS_KEY="test_secret"
export DEV_AWS_BUCKET_NAME="test_bucket"
export DEV_AWS_REGION="us-east-1"
export KAFKA_BOOTSTRAP_SERVERS="localhost:9092"
```

### 4. Ejecutar el API

**PowerShell:**
```powershell
$env:ENV_STATE="dev"; $env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"; python -m uvicorn storeapi.main:app --reload --host 0.0.0.0 --port 8000
```

**Bash/zsh:**
```bash
ENV_STATE=dev DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db" python -m uvicorn storeapi.main:app --reload --host 0.0.0.0 --port 8000
```

### 5. Ejecutar el Worker (opcional, en otra terminal)

**PowerShell:**
```powershell
$env:ENV_STATE="dev"; $env:DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db"; $env:KAFKA_BOOTSTRAP_SERVERS="localhost:9092"; python -m message_broker.worker
```

**Bash/zsh:**
```bash
ENV_STATE=dev DEV_DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/dev_db" KAFKA_BOOTSTRAP_SERVERS="localhost:9092" python -m message_broker.worker
```

### 6. Acceder a la documentaci√≥n

üåê **Swagger UI**: [http://localhost:8000/docs](http://localhost:8000/docs)  
üìö **ReDoc**: [http://localhost:8000/redoc](http://localhost:8000/redoc)

**Nota**: El servidor crear√° autom√°ticamente las tablas en PostgreSQL al iniciar.

---

## üìä Comparaci√≥n de Enfoques

| Caracter√≠stica | Docker Compose | Desarrollo Local |
|----------------|----------------|------------------|
| **Setup inicial** | Simple (`docker compose up`) | Manual (varios comandos) |
| **Aislamiento** | ‚úÖ Completo | ‚ö†Ô∏è Parcial |
| **Hot reload** | ‚úÖ S√≠ (con volumes) | ‚úÖ S√≠ |
| **Debugging** | ‚ö†Ô∏è Requiere attach | ‚úÖ Directo |
| **Recursos** | üî¥ Alto (todos los servicios) | üü¢ Bajo (solo necesarios) |
| **Producci√≥n-like** | ‚úÖ Muy similar | ‚ö†Ô∏è Diferente |
| **Recomendado para** | Tests, demos, CI/CD | Desarrollo activo, debugging |

---

## üìÅ Estructura del Proyecto

```
proyecto/
‚îú‚îÄ‚îÄ üìÇ storeapi/                     # Aplicaci√≥n principal API
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # Punto de entrada FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ database.py                  # Configuraci√≥n de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ security.py                  # Autenticaci√≥n JWT
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ routers/                  # Endpoints de la API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py                 # Gesti√≥n de usuarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video.py                # Upload y streaming de videos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vote.py                 # Sistema de votos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ranking.py              # Rankings y estad√≠sticas
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ models/                   # Modelos SQLAlchemy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vote.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ranking.py
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ tests/                    # Tests unitarios
‚îÇ       ‚îú‚îÄ‚îÄ conftest.py             # Configuraci√≥n de pytest
‚îÇ       ‚îú‚îÄ‚îÄ test_security.py        # Tests de autenticaci√≥n
‚îÇ       ‚îî‚îÄ‚îÄ routers/                # Tests de endpoints
‚îÇ
‚îú‚îÄ‚îÄ üìÇ message_broker/               # Sistema de mensajer√≠a
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ client.py                   # Cliente de Kafka
‚îÇ   ‚îú‚îÄ‚îÄ tasks_dispatcher.py         # Despachador de tareas
‚îÇ   ‚îî‚îÄ‚îÄ worker.py                   # Worker de procesamiento
‚îÇ
‚îú‚îÄ‚îÄ üìÇ utils/                        # Utilidades compartidas
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py                   # Configuraci√≥n global
‚îÇ   ‚îú‚îÄ‚îÄ cache.py                    # Gesti√≥n de cach√© Redis
‚îÇ   ‚îú‚îÄ‚îÄ logging_conf.py             # Configuraci√≥n de logs
‚îÇ   ‚îú‚îÄ‚îÄ ffmpeg.py                   # Procesamiento de video
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ s3/                       # Integraci√≥n con S3
‚îÇ       ‚îú‚îÄ‚îÄ s3.py                   # Cliente AWS S3
‚îÇ       ‚îî‚îÄ‚îÄ s3_local.py             # Storage local simulado
‚îÇ
‚îú‚îÄ‚îÄ üìÇ docs/                         # Documentaci√≥n t√©cnica
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ Entrega_1/
‚îÇ       ‚îú‚îÄ‚îÄ data_model.md
‚îÇ       ‚îú‚îÄ‚îÄ component_diagram.md
‚îÇ       ‚îú‚îÄ‚îÄ process_flow.md
‚îÇ       ‚îî‚îÄ‚îÄ deployment.md
‚îÇ
‚îú‚îÄ‚îÄ üìÇ capacity-planning/            # An√°lisis de capacidad
‚îÇ   ‚îú‚îÄ‚îÄ plan_de_capacidad.md
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ results/                  # Resultados de pruebas
‚îÇ
‚îú‚îÄ‚îÄ üìÇ postman/                      # Tests de integraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ collection.json             # Colecci√≥n Newman
‚îÇ   ‚îú‚îÄ‚îÄ environment.json            # Variables de entorno
‚îÇ   ‚îî‚îÄ‚îÄ report.html                 # Reportes generados
‚îÇ
‚îú‚îÄ‚îÄ üìÇ collections/                  # Colecciones Postman UI
‚îÇ   ‚îú‚îÄ‚îÄ Cloud-ANB.postman_collection.json
‚îÇ   ‚îî‚îÄ‚îÄ postman_environment.json
‚îÇ
‚îú‚îÄ‚îÄ üìÇ videos/                       # Almacenamiento local
‚îÇ   ‚îú‚îÄ‚îÄ uploaded/                   # Videos originales
‚îÇ   ‚îî‚îÄ‚îÄ processed/                  # Videos procesados
‚îÇ
‚îú‚îÄ‚îÄ üìÇ img/                          # Recursos
‚îÇ   ‚îî‚îÄ‚îÄ logo_nba.png                # Logo para branding
‚îÇ
‚îú‚îÄ‚îÄ üê≥ docker-compose.yml            # Orquestaci√≥n de servicios
‚îú‚îÄ‚îÄ üê≥ api.Dockerfile                # Imagen del API
‚îú‚îÄ‚îÄ üê≥ worker.Dockerfile             # Imagen del worker
‚îú‚îÄ‚îÄ üê≥ ffmpegpy.Dockerfile           # Imagen con FFmpeg
‚îú‚îÄ‚îÄ üìã requirements.txt              # Dependencias Python
‚îú‚îÄ‚îÄ üîß .env                          # Variables de entorno (crear)
‚îú‚îÄ‚îÄ üîß nginx.conf                    # Configuraci√≥n Nginx
‚îú‚îÄ‚îÄ üìú Makefile                      # Comandos automatizados
‚îú‚îÄ‚îÄ üìä monitor.sh                    # Script de monitoreo
‚îî‚îÄ‚îÄ üìñ README.md                     # Este archivo
```

### Descripci√≥n de Componentes

| Componente | Descripci√≥n | Tecnolog√≠a |
|------------|-------------|------------|
| **StoreAPI** | API REST para gesti√≥n de videos, votos y ranking | FastAPI + SQLAlchemy |
| **Message Broker** | Sistema de mensajer√≠a as√≠ncrona para tareas | Kafka + Python |
| **Worker** | Procesador de videos con branding y edici√≥n | FFmpeg + Python |
| **Database** | Almacenamiento de metadatos | PostgreSQL 15 |
| **Cache** | Cach√© de ranking y consultas frecuentes | Redis 7 |
| **Nginx** | Proxy reverso y balanceador de carga | Nginx |
| **Storage** | Almacenamiento de archivos de video | S3/Local |

---
